# Defaults for supabase-wrapper. Per-environment values override these.
replicaCount: 1

supabase:
  secret:
    jwt:
      secretRef: "supabase-secrets"
      secretRefKey:
        anonKey: jwt-anonKey
        serviceKey: jwt-serviceKey
        secret: jwt-secret
    db:
      secretRef: "supabase-secrets"
      secretRefKey:
        password: db-password
        database: db-database
    analytics:
      secretRef: "supabase-secrets"
      secretRefKey:
        publicAccessToken: analytics-publicAccessToken
        privateAccessToken: analytics-privateAccessToken
    smtp:
      secretRef: "supabase-secrets"
      secretRefKey:
        username: smtp-username
        password: smtp-password
    dashboard:
      secretRef: "supabase-secrets"
      secretRefKey:
        username: dashboard-username
        password: dashboard-password
        openAiApiKey: dashboard-openAiApiKey
    # TODO: Add S3 via minio
    realtime:
      secretRef: "supabase-secrets"
      secretRefKey:
        secretKeyBase: realtime-secretKeyBase
    meta:
      secretRef: "supabase-secrets"
      secretRefKey:
        cryptoKey: meta-cryptoKey

  db:
    enabled: true
    image:
      tag: 15.8.1.085
    livenessProbe:
      exec:
        command:
          - pg_isready
          - -U
          - postgres
      initialDelaySeconds: 3
    persistence:
      enabled: true
      storageClassName: longhorn
      size: 1Gi
    resources:
      requests:
        memory: "768Mi"
        cpu: "300m"
      limits:
        memory: "1152Mi"
        cpu: "700m"

  studio:
    image:
      tag: 2025.11.10-sha-5291fe3
    environment:
      DEFAULT_ORGANIZATION_NAME: Default Organization
      DEFAULT_PROJECT_NAME: Default Project
      SUPABASE_PUBLIC_URL: http://supabase.something.tld
      NEXT_PUBLIC_ENABLE_LOGS: true
    resources:
      requests:
        memory: "96Mi"
        cpu: "75m"
      limits:
        memory: "144Mi"
        cpu: "150m"

  auth:
    image:
      tag: v2.182.1
    environment:
      API_EXTERNAL_URL: http://supabase.something.tld
      GOTRUE_SITE_URL: http://supabase.something.tld
      GOTRUE_EXTERNAL_EMAIL_ENABLED: "true"
      GOTRUE_MAILER_AUTOCONFIRM: "true"
      GOTRUE_SMTP_ADMIN_EMAIL: "your-mail@supabase.something.tld"
      GOTRUE_SMTP_HOST: "smtp.supabase.something.tld"
      GOTRUE_SMTP_PORT: "587"
      GOTRUE_SMTP_SENDER_NAME: "your-mail@supabase.something.tld"
    resources:
      requests:
        memory: "96Mi"
        cpu: "75m"
      limits:
        memory: "144Mi"
        cpu: "150m"

  rest:
    image:
      tag: v13.0.7
    resources:
      requests:
        memory: "96Mi"
        cpu: "75m"
      limits:
        memory: "144Mi"
        cpu: "150m"

  realtime:
    image:
      tag: v2.63.0
    livenessProbe:
      httpGet:
        path: /
        port: 4000
      initialDelaySeconds: 3
    resources:
      requests:
        memory: "96Mi"
        cpu: "75m"
      limits:
        memory: "144Mi"
        cpu: "150m"

  meta:
    image:
      tag: v0.93.1
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "96Mi"
        cpu: "100m"

  # TODO: Fix storage
  storage:
    image:
      tag: v1.29.0
    livenessProbe:
      httpGet:
        path: /status
        port: 5000
      initialDelaySeconds: 3
    persistence:
      enabled: false
    resources:
      requests:
        memory: "96Mi"
        cpu: "75m"
      limits:
        memory: "144Mi"
        cpu: "150m"

  imgproxy:
    image:
      tag: v3.8.0
    environment:
      IMGPROXY_ENABLE_WEBP_DETECTION: "true"
    livenessProbe:
      exec:
        command:
          - imgproxy
          - health
      initialDelaySeconds: 3
    persistence:
      enabled: false
    resources:
      requests:
        memory: "96Mi"
        cpu: "75m"
      limits:
        memory: "144Mi"
        cpu: "150m"

  kong:
    image:
      repository: kong
      tag: 2.8.1
    environment:
      KONG_DECLARATIVE_CONFIG: /usr/local/kong/kong.yml
      KONG_LOG_LEVEL: info
    ingress:
      enabled: true
      className: "traefik"
      annotations:
        nginx.ingress.kubernetes.io/rewrite-target: /
        cert-manager.io/cluster-issuer: "letsencrypt-staging"
        kubernetes.io/tls-acme: "true"
      tls:
        []
        # - secretName: supabase-tls
        #   hosts:
        #     - supabase.something.tld
      hosts:
        - host: supabase.something.tld
          paths:
            - path: /
              pathType: Prefix
    # resources: # TODO: Memory leaks prevent from setting fixed resources here
    #   requests:
    #     memory: "96Mi"
    #     cpu: "75m"
    #   limits:
    #     memory: "144Mi"
    #     cpu: "150m"

  analytics:
    enabled: false # TODO: Disabled for now due to low memmory
    image:
      tag: 1.22.6
    livenessProbe:
      httpGet:
        path: /health
        port: 4000
      initialDelaySeconds: 3
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "96Mi"
        cpu: "100m"

  vector:
    enabled: false # TODO: Disabled for now due to low memmory
    image:
      tag: 0.28.1-alpine
    livenessProbe:
      httpGet:
        path: /health
        port: 9001
      initialDelaySeconds: 3
    ## Vector requires logs from the control plane to function.
    ## This is normally stored in /var/log/pods
    ## Modify these values according to your environment.
    volumeMounts:
      - name: pod-logs
        mountPath: /var/log/pods
    volumes:
      - name: pod-logs
        hostPath:
          path: /var/log/pods
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "96Mi"
        cpu: "100m"

  functions:
    image:
      tag: v1.68.4
    resources:
      requests:
        memory: "96Mi"
        cpu: "75m"
      limits:
        memory: "144Mi"
        cpu: "150m"
# Minio
# resources:
#   requests:
#     memory: "96Mi"
#     cpu: "75m"
#   limits:
#     memory: "144Mi"
#     cpu: "150m"

# Some profiles from ChatGPT:

# Minimal profile (requests ≈ 1184 Mi, limits ≈ 1776 Mi)
# | Service    | request memory | request CPU | limit memory | limit CPU |
# | ---------- | -------------: | ----------: | -----------: | --------: |
# | db         |          512Mi |        200m |        768Mi |      500m |
# | studio     |           64Mi |         50m |         96Mi |      100m |
# | auth       |           64Mi |         50m |         96Mi |      100m |
# | rest       |           64Mi |         50m |         96Mi |      100m |
# | realtime   |           64Mi |         50m |         96Mi |      100m |
# | meta       |           32Mi |         25m |         48Mi |       50m |
# | storage    |           64Mi |         50m |         96Mi |      100m |
# | imgproxy   |           64Mi |         50m |         96Mi |      100m |
# | kong       |           64Mi |         50m |         96Mi |      100m |
# | analytics  |           32Mi |         25m |         48Mi |       50m |
# | vector     |           32Mi |         25m |         48Mi |       50m |
# | functions  |           64Mi |         50m |         96Mi |      100m |
# | minio      |           64Mi |         50m |         96Mi |      100m |
# | **Totals** |     **1184Mi** |    **725m** |   **1776Mi** | **1550m** |

# Conservative profile (requests ≈ 1824 Mi, limits ≈ 2736 Mi)
# | Service    | request memory | request CPU | limit memory | limit CPU |
# | ---------- | -------------: | ----------: | -----------: | --------: |
# | db         |          768Mi |        300m |       1152Mi |      700m |
# | studio     |           96Mi |         75m |        144Mi |      150m |
# | auth       |           96Mi |         75m |        144Mi |      150m |
# | rest       |           96Mi |         75m |        144Mi |      150m |
# | realtime   |           96Mi |         75m |        144Mi |      150m |
# | meta       |           64Mi |         50m |         96Mi |      100m |
# | storage    |           96Mi |         75m |        144Mi |      150m |
# | imgproxy   |           96Mi |         75m |        144Mi |      150m |
# | kong       |           96Mi |         75m |        144Mi |      150m |
# | analytics  |           64Mi |         50m |         96Mi |      100m |
# | vector     |           64Mi |         50m |         96Mi |      100m |
# | functions  |           96Mi |         75m |        144Mi |      150m |
# | minio      |           96Mi |         75m |        144Mi |      150m |
# | **Totals** |     **1824Mi** |   **1125m** |   **2736Mi** | **2350m** |

# ------

# Ultra-compact profile (recommended for 3 instances on one 8GiB node)
# Disabled by default: analytics, vector (enable only if you have extra memory).
# | Service       | request memory | request CPU | limit memory | limit CPU |
# | ------------- | -------------: | ----------: | -----------: | --------: |
# | db (Postgres) |          512Mi |        200m |       1024Mi |      500m |
# | studio        |           48Mi |         25m |         96Mi |      100m |
# | auth          |           48Mi |         25m |         96Mi |      100m |
# | rest          |           48Mi |         25m |         96Mi |      100m |
# | realtime      |           64Mi |         50m |        128Mi |      200m |
# | meta          |           24Mi |         25m |         48Mi |       50m |
# | storage       |           64Mi |         50m |        128Mi |      200m |
# | imgproxy      |           48Mi |         50m |        128Mi |      200m |
# | kong          |           48Mi |         50m |        128Mi |      200m |
# | functions     |           64Mi |         50m |        128Mi |      200m |
# | minio         |           96Mi |         50m |        192Mi |      200m |

# Totals (Ultra-compact)
# Requests (memory): 512 + 48 + 48 + 48 + 64 + 24 + 64 + 48 + 48 + 64 + 96      = 1064 Mi (≈ 1.04 GiB)
# Limits (memory): 1024 + 96 + 96 + 96 + 128 + 48 + 128 + 128 + 128 + 128 + 192 = 2192 Mi (≈ 2.14 GiB)
# Requests (CPU): 200 + 25 + 25 + 25 + 50 + 25 + 50 + 50 + 50 + 50 + 50         =  600  m (0.6 CPU)
# Limits (CPU): 500 + 100 + 100 + 100 + 200 + 50 + 200 + 200 + 200 + 200 + 200  = 2050  m (2.05 CPU)
